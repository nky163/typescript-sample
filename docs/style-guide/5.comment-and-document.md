# コメントとドキュメント

## JSDoc と `//` の目的の違いと使い分け

- JSDoc は 公開インターフェースの契約（前提 / 戻り値 / 例外 / 副作用） を示し、呼び出し側が安全に利用できる文脈を提供
- `//` は 実装戦略 / 選択理由 / 計測結果など、呼び出し側が知る必要のない内部判断を残す
- 役割を混在させるとツール出力がノイズ化し、本当に読むべき契約が埋もれる

**❌ bad**

```typescript
// ユーザを保存する関数です 引数 user を保存します
export function saveUser(user: User) {
  /* ... */
}
```

**✅ good**

```typescript
/** 永続層へユーザを保存する。
 * - 既存 id の場合は upsert
 * - トランザクション境界は呼び出し側で管理
 */
export function saveUser(user: User) {
  /* ... */
}

function buildSql() {
  // 単純なのでプリペアドステートメント未使用（パフォーマンス計測 2025-08）
}
```

## JSDoc ルール

### JSDoc は“名前+型”以上の情報で必要なもののみを記述

- 目的: 型シグネチャで取得できない契約(制約 / SLO / 例外 / 副作用 / ドメイン意図)を明示
- 自明な再説明 ("ユーザを取得する関数") は将来の変更点を増やし腐敗要因
- 型を JSDoc に二重記載 (@param {User} など) すると乖離リスク; 省いて説明領域を確保
- “そのコメントが無いとレビューで質問が出るか” を基準に記述可否を判断

**❌ bad**

```typescript
/** ユーザを取得する関数 */
function getUser(id: UserId): User | undefined {
  /* ... */
}

/** ユーザを取得する関数 @param id {UserId} */
function getUser(id: UserId): User | undefined {
  /* 価値のない冗長説明 + 型重複 */
}

/**
 * @param user {User} ユーザ
 * @return {Promise<Result>} 結果
 */
async function register(user: User): Promise<Result> {
  /* 型を重複記載 */
}
```

**✅ good**

```typescript
/** ID でユーザを取得
 * - 見つからなければ undefined
 * - キャッシュ層未ヒットは 50ms 以内 (SLO)
 */
function getUser(id: UserId): User | undefined {
  /* ... */
}

/** ID でユーザを取得
 * - 見つからなければ undefined (存在しないだけで例外は投げない)
 * - キャッシュ未ヒットは 50ms 以内 (SLO) を目標
 */
function getUser(id: UserId): User | undefined {
  /* ... */
}

/** 登録処理。
 * - バリデーション失敗時 ValidationError を throw
 * - Side effect: メール送信は非同期キュー投入のみ（同期待ちなし）
 */
async function register(user: User): Promise<Result> {
  /* ... */
}
```

### エクスポートされたトップレベルシンボルには JSDoc を付与する

- 内部ユーティリティは export しない = JSDoc も不要で公開面を最小化

**❌ bad**

```typescript
export function calculateFee(amount: Money): Money {
  /* 仕様不明 */
}
```

**✅ good**

```typescript
/**
 * 手数料計算。
 * - 切り捨て: 小数第2位
 * - 負数は IllegalArgumentError
 */
export function calculateFee(amount: Money): Money {
  /* ... */
}
```

### クラス JSDoc はライフサイクルと責務に焦点をあてる（“いつ / 何のために”）

- 責務境界を文章化し SRP/境界逸脱レビューを容易に
- コンストラクタ引数の単なる再説明は不要（型で読める）
- 利用上の前提 (スレッド安全性 / トランザクション管理者ではない 等) を列挙

**❌ bad**

```typescript
/** ユーザサービスクラス */
export class UserService {
  /* ... */
}
```

**✅ good**

```typescript
/** ユーザ集約の読み書き調停者。
 * - リポジトリと外部通知(EmailGateway) の整合性を確保
 * - トランザクションは呼び出し層で開始
 */
export class UserService {
  /* ... */
}
```

### パラメータプロパティは @param で一括説明（フィールドごとの重複を避ける）

- 依存のライフサイクル / スレッド安全性 / 同期 or 非同期性など動作特性を記述
- “何者か” より “なぜここに注入されるか / 期待契約” を記す
- 1 箇所に集中し引数追加/削除の追従漏れを防止

**❌ bad**

```typescript
class UserService {
  /** ユーザリポジトリ */
  constructor(private readonly repo: UserRepository) {}
}
```

**✅ good**

```typescript
/** 永続層に依存するユースケース調停者 */
class UserService {
  /** @param repo ユーザ永続化境界。メソッドは即時 I/O を伴う */
  constructor(private readonly repo: UserRepository) {}
}
```

### 一行で要約不能になった JSDoc は速やかに multi-line 化する

- 箇条書きで差分が行単位に分離されレビューが容易
- 早めの段階でブロック化して肥大化を防ぎ構造化した情報整理

**❌ bad**

```typescript
/** 非同期にユーザをフェッチし失敗時リトライしそれでも失敗したらフォールバック値を返してキャッシュを更新する */
async function loadUser() {
  /* ... */
}
```

**✅ good**

```typescript
/**
 * ユーザ取得:
 * - 3 回指数バックオフリトライ
 * - 失敗時フォールバック + WARN ログ
 * - 成功/失敗双方でキャッシュ更新
 */
async function loadUser() {
  /* ... */
}
```

### Markdown 記法 (箇条書き / インラインコード) を積極活用

- 箇条書きは追加/削除 diff が明瞭で履歴追跡容易
- インラインコード `` `symbol` `` で識別子が文中から視覚的に独立
- 状態や前提条件を列挙し網羅性チェックを支援

**❌ bad**

```typescript
/** サポートする状態: queued processing finished */
interface Job {
  status: JobStatus;
}
```

**✅ good**

```typescript
/** サポート状態:
 * - `queued`
 * - `processing`
 * - `finished`
 */
interface Job {
  status: JobStatus;
}
```

---

## 行コメント (`//`) について

（以下は公開契約ではなく実装判断を明確化するための基準）

### 複数行実装コメントは `//` を縦に並べ差分最適化

- 行単位 blame / diff が直感的（ブロック全体改変扱いを避ける）
- ネスト構造や一時コメントアウト操作が単純
- ツールチェーン（プリティア等）で意図しない再整形が起きにくい

**❌ bad**

```typescript
/*
 実装注意: N+1 回避のため一括ロード
 キャッシュヒット率が低いため将来最適化候補
*/
function loadAll() {}
```

**✅ good**

```typescript
// 実装注意: N+1 回避で一括ロード
// キャッシュヒット率が低いため将来最適化候補
function loadAll() {}
```

### コメントアウトされた “死んだコード” は VCS を信頼し即削除

- 履歴が保証しているので “念のため残す” 必要はない
- 化石コードの存在はリファクタ時の探索コストと心理的負債になる

**❌ bad**

```typescript
// function legacy() { /* ... */ }
```

**✅ good**

```typescript
// 削除: commit 123abc 参照
```
